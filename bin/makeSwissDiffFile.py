#!/usr/local/bin/python
#
#  makeSwissDiffFile.py
###########################################################################
#
#  Purpose:
#
#      This script will create an output file that contains all of the
#      MGI/SwissDiff associations in the database.
#
#  Usage:
#
#      makeSwissDiffFile.py
#
#  Env Vars:
#
#      The following environment variables are set by the configuration
#      file that is sourced by the wrapper script:
#
#	   MGI_UNIPROT_LOAD_FILE
#          MGI_SWISSPROT_LOAD_FILE
#
#  Inputs:
#
#      - MGI/UniProt load file ($MGI_UNIPROT_LOAD_FILE)
#        List of MGI/UniProt associations generated by the most recent bucketization.
#        It has the following tab-delimited fields:
#
#        1) MGI ID (for a marker)
#        2) Swiss-Prot ID
#        3) TrEMBL ID
#        4) EC IDs (comma-separated)
#        5) PDB IDs (comma-separated)
#
#  Outputs:
#
#      - MGI/SwissProt association file from the database with
#        the following tab-delimited fields:
#
#        1) MGI ID (for a marker)
#        2) SwissProt ID
#        3) TrEMBL ID
#
#      - MGI/SwissProt vs. MGI/UniProt buckets
#        Each file name is prefixed as follows:
#
#        ${BUCKET_PREFIX}.0_1.txt
#        ${BUCKET_PREFIX}.1_0.txt
#        ${BUCKET_PREFIX}.1_1.txt
#        ${BUCKET_PREFIX}.1_n.txt
#        ${BUCKET_PREFIX}.n_1.txt
#        ${BUCKET_PREFIX}.n_n.txt
#
#  Exit Codes:
#
#      0:  Successful completion
#      1:  An exception occurred
#
#  Assumes:  Nothing
#
#  Implementation:
#
#      This script will perform following steps:
#
#      1) Initialize variables.
#      2) Open files.
#      3) Create a file of MGI/SwissProt associations in the database	
#      4) Create a file of MGI/SwissProt vs. MGI/UniProt buckets
#      5) Close files.
#
#  Notes:  None
#
###########################################################################

import sys 
import os
import string
import db

FIELDS = [ 'MGI ID', 'SWISS-PROT', 'TrEMBL' ]

DEFAULT_BUCKETDIR = os.getcwd()
DEFAULT_BUCKET_PREFIX = 'bucket'

B0_1 = '0_1'
B1_0 = '1_0'
B1_1 = '1_1'
B1_N = '1_N'
BN_1 = 'N_1'
BN_N = 'N_N'

BUCKETLIST = [ B0_1, B1_0, B1_1, B1_N, BN_1, BN_N ]

bucket = {}
bucketizer = None

#
# Purpose: Initialization
# Returns: Nothing
# Assumes: Nothing
# Effects: Nothing
# Throws: Nothing
#
def initialize():
    global spAssocFile, fpAssoc
    global newAssocFile, oldAssocFile
    global bucketDir, bucketPrefix
    global bucket

    oldAssocFile = os.getenv('MGI_SWISSPROT_LOAD_FILE')
    newAssocFile = os.getenv('MGI_UNIPROT_LOAD_FILE')
    bucketDir = os.getenv('BUCKETDIR')
    bucketPrefix = 'mgi_swissprot'

    rc = 0

    #
    # Make sure the required environment variables are set.
    #
    if not spAssocFile:
        print 'Environment variable not set: MGI_SWISSPROT_LOAD_FILE'
        rc = 1

    #
    # Make sure the required environment variables are set.
    #
    if not newAssocFile:
        print 'Environment variable not set: MGI_UNIPROT_LOAD_FILE'
        rc = 1
    if not oldAssocFile:
        print 'Environment variable not set: MGI_UNIPROT_OLDLOAD'
        rc = 1

    #
    # Use defaults for optional environment variables that are not set.
    #
    if not bucketDir:
        bucketDir = DEFAULT_BUCKETDIR
    if not bucketPrefix:
        bucketPrefix = DEFAULT_BUCKET_PREFIX

    #
    # Initialize file pointers.
    #
    for i in BUCKETLIST:
        bucket[i] = None


    #
    # Initialize file pointers.
    #
    fpAssoc = None

    return rc


#
# Purpose: Open files.
# Returns: Nothing
# Assumes: Nothing
# Effects: Nothing
# Throws: Nothing
#
def openFiles():
    global fpAssoc

    #
    # Open the report files.
    #
    try:
        fpAssoc = open(spAssocFile, 'w')
    except:
        print 'Cannot open report: ' + spAssocFile
        return 1

    return 0


#
# Purpose: Close files.
# Returns: Nothing
# Assumes: Nothing
# Effects: Nothing
# Throws: Nothing
#
def closeFiles():
    if fpAssoc:
        fpAssoc.close()

    return 0


#
# Purpose: Create a file of the MGI/SwissProt associations in the database
# Returns: Nothing
# Assumes: Nothing
# Effects: Nothing
# Throws: Nothing
#
def getAssociations():
    #
    # Get all the MGI/SwissProt association 
    #
    results = db.sql('''
		     select a1.accID "mgiID", a2.accID "uniprotID", a2._LogicalDB_key
                     from ACC_Accession a1, ACC_Accession a2 
                     where a1._MGIType_key = 2
                           and a1._LogicalDB_key = 1 
                           and a1.prefixPart = "MGI:" 
                           and a1.preferred = 1 
                           and a1._Object_key = a2._Object_key 
                           and a2._MGIType_key = 2 
                           and a2._LogicalDB_key in (13,41) 
                           and a2._CreatedBy_key = 1442 
                     order by a1.accID, a1._LogicalDB_key, a2.accID
		     ''', 'auto')

    #
    # Write the MGI/SwissProt associations to the file.
    #

    mgiList = []
    spList = {}
    trList = {}

    for r in results:

        mgiID = r['mgiID']
        uniprotID = r['uniprotID']
	ldb = r['_LogicalDB_key']

	if mgiID not in mgiList:
	    mgiList.append(mgiID)

	if ldb == 13:
	    if not spList.has_key(mgiID):
	        spList[mgiID] = []
            spList[mgiID].append(uniprotID)

	if ldb == 41:
	    if not trList.has_key(mgiID):
	        trList[mgiID] = []
            trList[mgiID].append(uniprotID)

    for mgiID in mgiList:
        fpAssoc.write(mgiID + '\t')

	if spList.has_key(mgiID):
	    fpAssoc.write(string.join(spList[mgiID], ','))
        fpAssoc.write('\t')

	if trList.has_key(mgiID):
	    fpAssoc.write(string.join(trList[mgiID], ','))
        fpAssoc.write('\n')

    return 0


#
#  MAIN
#

if initialize() != 0:
    sys.exit(1)

if openFiles() != 0:
    sys.exit(1)

if getAssociations() != 0:
    closeFiles()
    sys.exit(1)

closeFiles()
sys.exit(0)
